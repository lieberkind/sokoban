<html>
<head>
    <meta charset="UTF-8">
    <title>Document</title>

    <style>
        * { margin: 0; padding: 0; }
        canvas { 
            background: cyan;
            width: 304px;
            height: 272px;
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>
    <script>
        var DIRECTIONS = {
            up: 'up',
            right: 'right',
            down: 'down',
            left: 'left',
            none: 'none'
        };

        var level1 = [
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "b", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
            ["s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s", "s"],
        ];

        function Player(game, initPosX, initPosY) {
            this.game = game;
            this.position = {
                x: initPosX,
                y: initPosY
            }
        }

        Player.prototype.isWithinLevel = function(dPosition) {
            var level = this.game.level;

            return dPosition.x < level[this.position.y].length &&
                dPosition.x >= 0 &&
                dPosition.y < level.length &&
                dPosition.y >= 0 &&
                level[dPosition.y][dPosition.x] !== 'b';
        };

        Player.prototype.canMove = function(direction) {
            var dPosition;

            switch (direction) {
                case DIRECTIONS.up:
                    dPosition = { x: this.position.x, y: this.position.y - 1};
                    break;
                case DIRECTIONS.right:
                    dPosition = { x: this.position.x + 1, y: this.position.y};
                    break;
                case DIRECTIONS.down:
                    dPosition = { x: this.position.x, y: this.position.y + 1};
                    break;
                case DIRECTIONS.left:
                    dPosition = { x: this.position.x - 1, y: this.position.y};
                    break;
                default:
                    dPosition = { x: this.position.x, y: this.position.y };
                    break;
            }

            var crates = this.game.gameObjects.filter(function(gameObject) {
                return gameObject.constructor === Crate;
            });

            var canMoveCrate = true;

            crates.forEach(function(crate) {
                if(crate.position.x === dPosition.x && crate.position.y === dPosition.y) {
                    canMoveCrate = canMoveCrate && crate.canMove(direction);
                }
            });

            return this.isWithinLevel(dPosition) && canMoveCrate;
        };

        Player.prototype.move = function(direction) {
            var self = this;

            switch (direction) {
                case DIRECTIONS.up:
                    this.position.y--;
                    break;
                case DIRECTIONS.right:
                    this.position.x++;
                    break;
                case DIRECTIONS.down:
                    this.position.y++;
                    break;
                case DIRECTIONS.left:
                    this.position.x--;
                    break;
                default: break;
            }

            var crates = this.game.gameObjects.filter(function(gameObject) {
                return gameObject.constructor === Crate;
            });

            crates.forEach(function(crate) {
                if(crate.position.x === self.position.x && crate.position.y === self.position.y) {
                    crate.move(direction);
                }
            });
        };

        Player.prototype.draw = function() {
            var ctx = this.game.ctx;
            ctx.beginPath();
            ctx.rect(this.position.x * 16, this.position.y * 16, 16, 16);
            ctx.fillStyle = '#F00';
            ctx.fill();
            ctx.closePath();
        };

        Player.prototype.update = function() {
            var direction;

            direction = this.game.getPressedDirection();

            if(this.canMove(direction)) {
                this.move(direction);
            };
        }

        function Block(game, posX, posY) {
            this.game = game;
            this.position = {
                x: posX,
                y: posY
            };
        }

        Block.prototype.draw = function() {
            this.game.ctx.beginPath();
            this.game.ctx.rect(this.position.x * 16, this.position.y * 16, 16, 16);
            this.game.ctx.fillStyle = '#CCC';
            this.game.ctx.fill();
            this.game.ctx.closePath();
        };

        Block.prototype.update = function() {};

        function Crate(game, posX, posY) {
            this.game = game;
            this.position = {
                x: posX,
                y: posY
            };
        };

        Crate.prototype.isWithinLevel = function(dPosition) {
            var level = this.game.level;

            return dPosition.x < level[this.position.y].length &&
                dPosition.x >= 0 &&
                dPosition.y < level.length &&
                dPosition.y >= 0 &&
                level[dPosition.y][dPosition.x] !== 'b';
        }

        Crate.prototype.canMove = function(direction) {
            var dPosition;

            switch (direction) {
                case DIRECTIONS.up:
                    dPosition = { x: this.position.x, y: this.position.y - 1};
                    break;
                case DIRECTIONS.right:
                    dPosition = { x: this.position.x + 1, y: this.position.y};
                    break;
                case DIRECTIONS.down:
                    dPosition = { x: this.position.x, y: this.position.y + 1};
                    break;
                case DIRECTIONS.left:
                    dPosition = { x: this.position.x - 1, y: this.position.y};
                    break;
                default:
                    dPosition = { x: this.position.x, y: this.position.y };
                    break;
            }

            var crates = this.game.gameObjects.filter(function(gameObject) {
                return gameObject.constructor === Crate;
            });

            var crateIsBlocking = false;

            crates.forEach(function(crate) {
                if(crate.position.x === dPosition.x && crate.position.y === dPosition.y) {
                    crateIsBlocking = true;
                }
            });

            return this.isWithinLevel(dPosition) && !crateIsBlocking;
        };

        Crate.prototype.move = function(direction) {
            switch (direction) {
                case DIRECTIONS.up:
                    this.position.y--;
                    break;
                case DIRECTIONS.right:
                    this.position.x++;
                    break;
                case DIRECTIONS.down:
                    this.position.y++;
                    break;
                case DIRECTIONS.left:
                    this.position.x--;
                    break;
                default: break;
            }
        };

        Crate.prototype.update = function() {};

        Crate.prototype.draw = function() {
            this.game.ctx.beginPath();
            this.game.ctx.rect(this.position.x * 16, this.position.y * 16, 16, 16);
            this.game.ctx.fillStyle = '#FF0';
            this.game.ctx.fill();
            this.game.ctx.closePath();
        };

        function Game(ctx) {
            this.ctx = ctx;
            this.gameObjects = [];
            this.pressedDirection = DIRECTIONS.none;
        }

        Game.prototype.draw = function() {
            this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
            this.gameObjects.forEach(function(gameObject) {
                gameObject.draw();
            });
        };

        Game.prototype.update = function() {
            this.gameObjects.forEach(function(gameObject) {
                gameObject.update();
            });
            this.resetInputs();
        };

        Game.prototype.resetInputs = function() {
            this.pressedDirection = DIRECTIONS.none;
        };

        Game.prototype.getPressedDirection = function() {
            return this.pressedDirection;
        };

        Game.prototype.setPressedDirection = function(direction) {
            this.pressedDirection = direction;
        };

        Game.prototype.loadLevel = function(level) {
            var self = this;
            this.level = level;

            level.forEach(function(row, rowIdx) {
                row.forEach(function(field, fieldIdx) {
                    if(field === 'b') {
                        self.addGameObject(new Block(self, fieldIdx, rowIdx));
                    }

                    if(field === 'p') {
                        self.addGameObject(new Player(game, fieldIdx, rowIdx));
                    }
                });
            });
        }

        Game.prototype.addGameObject = function(obj) {
            this.gameObjects.push(obj);
        };

        var canvas = document.getElementById('game');
        canvas.width = 304;
        canvas.height = 272;

        var game = new Game(canvas.getContext('2d'));
        game.loadLevel(level1);
        game.addGameObject(new Crate(game, 4, 7));
        game.addGameObject(new Crate(game, 7, 4));
        game.addGameObject(new Crate(game, 2, 1));
        game.addGameObject(new Crate(game, 10, 0));
        game.addGameObject(new Player(game, 0, 0));

        addEventListener('keydown', function(e) {
            switch (e.keyCode) {
                case 37:
                    game.setPressedDirection(DIRECTIONS.left);
                    break;
                case 38:
                    game.setPressedDirection(DIRECTIONS.up);
                    break;
                case 39:
                    game.setPressedDirection(DIRECTIONS.right);
                    break;
                case 40:
                    game.setPressedDirection(DIRECTIONS.down);
                    break;
                default:
                    game.setPressedDirection(DIRECTIONS.none);
                    break;
            }

            game.update();
            game.draw();
        });

        game.update();
        game.draw();
    </script>
</body>
</html>
